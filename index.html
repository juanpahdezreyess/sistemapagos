<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Escolar - GestiÃ³n de Pagos</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 0;
            background-color: #f5f7fa;
            color: #333;
        }
        
        header {
            background-color: #2c3e50;
            color: white;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        nav {
            display: flex;
            justify-content: center;
            gap: 1rem;
            padding: 1rem;
            background-color: #34495e;
            flex-wrap: wrap;
        }
        
        .nav-button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 0.7rem 1.5rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .nav-button:hover {
            background-color: #2980b9;
            transform: translateY(-2px);
        }
        
        main {
            max-width: 1000px;
            margin: 2rem auto;
            padding: 1.5rem;
            background-color: white;
            box-shadow: 0 0 15px rgba(0,0,0,0.1);
            border-radius: 8px;
        }
        
        .seccion {
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .seccion-activa {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        form {
            display: grid;
            gap: 1.2rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .campo {
            display: grid;
            gap: 0.5rem;
        }
        
        label {
            font-weight: 600;
            color: #2c3e50;
        }
        
        input, select {
            padding: 0.7rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }
        
        button[type="submit"] {
            background-color: #27ae60;
            color: white;
            border: none;
            padding: 0.8rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            margin-top: 1rem;
            transition: background-color 0.3s;
        }
        
        button[type="submit"]:hover {
            background-color: #219653;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1.5rem;
            box-shadow: 0 0 10px rgba(0,0,0,0.05);
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .accion-btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s;
        }
        
        .pagar-btn {
            background-color: #3498db;
            color: white;
        }
        
        .pagar-btn:hover {
            background-color: #2980b9;
        }
        
        .mensaje-exito {
            background-color: #d4edda;
            color: #155724;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        footer {
            text-align: center;
            padding: 1.5rem;
            background-color: #ecf0f1;
            margin-top: 2rem;
        }
        
        @media (max-width: 768px) {
            main {
                margin: 1rem;
                padding: 1rem;
            }
            
            th, td {
                padding: 0.7rem 0.5rem;
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Sistema de GestiÃ³n Escolar</h1>
        <p>AdministraciÃ³n de alumnos y pagos</p>
    </header>

    <nav>
        <button class="nav-button" onclick="mostrarSeccion('registro')">âž• Nuevo Alumno</button>
        <button class="nav-button" onclick="mostrarSeccion('lista')">ðŸ‘¥ Lista de Alumnos</button>
        <button class="nav-button" onclick="mostrarSeccion('pagos')">ðŸ’° Registrar Pagos</button>
        <button class="nav-button" onclick="mostrarSeccion('reportes')">ðŸ“Š Reportes</button>
    </nav>

    <main>
        <div id="mensaje-exito" class="mensaje-exito"></div>

        <!-- SecciÃ³n de Registro -->
        <section id="registro" class="seccion seccion-activa">
            <h2>Registrar Nuevo Alumno</h2>
            <form id="formulario-alumno">
                <div class="campo">
                    <label for="nombre">Nombre Completo:</label>
                    <input type="text" id="nombre" required>
                </div>
                
                <div class="campo">
                    <label for="grado">Grado:</label>
                    <select id="grado" required>
                        <option value="">Seleccione...</option>
                        <option value="1Â° Primaria">1Â° Primaria</option>
                        <option value="2Â° Primaria">2Â° Primaria</option>
                        <option value="3Â° Primaria">3Â° Primaria</option>
                        <option value="4Â° Primaria">4Â° Primaria</option>
                        <option value="5Â° Primaria">5Â° Primaria</option>
                        <option value="6Â° Primaria">6Â° Primaria</option>
                        <option value="1Â° Secundaria">1Â° Secundaria</option>
                        <option value="2Â° Secundaria">2Â° Secundaria</option>
                        <option value="3Â° Secundaria">3Â° Secundaria</option>
                    </select>
                </div>
                
                <div class="campo">
                    <label for="grupo">Grupo:</label>
                    <input type="text" id="grupo" required placeholder="Ej. A" maxlength="1" style="text-transform:uppercase">
                </div>
                
                <div class="campo">
                    <label for="mensualidad">Mensualidad ($):</label>
                    <input type="number" id="mensualidad" step="0.01" min="0" required>
                </div>
                
                <div class="campo">
                    <label for="beca">Beca (%):</label>
                    <input type="number" id="beca" min="0" max="100" value="0">
                </div>
                
                <button type="submit">Guardar Alumno</button>
            </form>
        </section>

        <!-- SecciÃ³n de Lista de Alumnos -->
        <section id="lista" class="seccion">
            <h2>Alumnos Registrados</h2>
            <div id="contenedor-alumnos">
                <!-- AquÃ­ se cargarÃ¡n los alumnos dinÃ¡micamente -->
            </div>
        </section>

        <!-- SecciÃ³n de Pagos -->
        <section id="pagos" class="seccion">
            <h2>Registrar Pagos</h2>
            <div id="contenedor-pagos">
                <!-- Formulario de pagos se cargarÃ¡ aquÃ­ -->
            </div>
        </section>

        <!-- SecciÃ³n de Reportes -->
        <section id="reportes" class="seccion">
            <h2>Reportes y EstadÃ­sticas</h2>
            <div id="contenedor-reportes">
                <!-- Reportes se generarÃ¡n aquÃ­ -->
            </div>
        </section>
    </main>

    <footer>
        <p>Sistema Escolar &copy; <span id="year"></span> | Todos los derechos reservados</p>
    </footer>

    <script>
        // Mostrar aÃ±o actual
        document.getElementById('year').textContent = new Date().getFullYear();

        // Clase para gestionar alumnos
        class SistemaEscolar {
            constructor() {
                this.alumnos = this.cargarAlumnos();
                this.cargarDesdeJSONBin(); // Intenta cargar datos de la nube al iniciar
            }

            // Cargar alumnos desde LocalStorage
            cargarAlumnos() {
                const alumnosGuardados = localStorage.getItem('alumnosEscuela');
                try {
                    return alumnosGuardados ? JSON.parse(alumnosGuardados) : [];
                } catch (e) {
                    console.error("Error al cargar alumnos:", e);
                    return [];
                }
            }

            // Guardar alumnos en LocalStorage
            guardarAlumnos() {
                localStorage.setItem('alumnosEscuela', JSON.stringify(this.alumnos));
                this.guardarEnJSONBin(); // Guarda tambiÃ©n en la nube
            }

            // Registrar nuevo alumno
            registrarAlumno(nombre, grado, grupo, mensualidad, beca = 0) {
                const nuevoAlumno = {
                    id: Date.now().toString(),
                    nombre,
                    grado,
                    grupo: grupo.toUpperCase(),
                    mensualidad: parseFloat(mensualidad),
                    beca: parseFloat(beca),
                    pagos: [],
                    adeudo: mensualidad * (1 - beca/100) * 10 // Adeudo anual estimado
                };
                
                this.alumnos.push(nuevoAlumno);
                this.guardarAlumnos();
                return nuevoAlumno;
            }

            // Registrar pago para un alumno
            registrarPago(idAlumno, monto, concepto) {
                const alumno = this.alumnos.find(a => a.id === idAlumno);
                if (!alumno) return false;

                const nuevoPago = {
                    fecha: new Date().toISOString(),
                    monto: parseFloat(monto),
                    concepto
                };

                alumno.pagos.push(nuevoPago);
                alumno.adeudo -= nuevoPago.monto;
                this.guardarAlumnos();
                return true;
            }

            // Obtener alumno por ID
            obtenerAlumno(id) {
                return this.alumnos.find(a => a.id === id);
            }

            // Generar lista HTML de alumnos
            generarListaAlumnos() {
                if (this.alumnos.length === 0) {
                    return '<div class="mensaje-vacio">No hay alumnos registrados aÃºn.</div>';
                }

                let html = '<table><thead><tr>';
                html += '<th>Nombre</th><th>Grado</th><th>Grupo</th>';
                html += '<th>Mensualidad</th><th>Beca</th><th>Adeudo</th><th>Acciones</th>';
                html += '</tr></thead><tbody>';

                this.alumnos.sort((a, b) => a.nombre.localeCompare(b.nombre)).forEach(alumno => {
                    html += `<tr>
                        <td>${alumno.nombre}</td>
                        <td>${alumno.grado}</td>
                        <td>${alumno.grupo}</td>
                        <td>$${alumno.mensualidad.toFixed(2)}</td>
                        <td>${alumno.beca}%</td>
                        <td>$${alumno.adeudo.toFixed(2)}</td>
                        <td>
                            <button class="accion-btn pagar-btn" onclick="mostrarPago('${alumno.id}')">Pagar</button>
                        </td>
                    </tr>`;
                });

                html += '</tbody></table>';
                return html;
            }

            // Generar formulario de pago
            generarFormularioPago(idAlumno) {
                const alumno = this.obtenerAlumno(idAlumno);
                if (!alumno) return '<div class="mensaje-error">Alumno no encontrado</div>';

                let html = `<div class="info-alumno">
                    <h3>${alumno.nombre}</h3>
                    <p><strong>Grado:</strong> ${alumno.grado} ${alumno.grupo}</p>
                    <p><strong>Adeudo actual:</strong> $${alumno.adeudo.toFixed(2)}</p>
                </div>`;
                
                html += `<form id="formulario-pago">
                    <div class="campo">
                        <label for="monto-pago">Monto:</label>
                        <input type="number" id="monto-pago" step="0.01" min="0.01" max="${alumno.adeudo}" required>
                    </div>
                    <div class="campo">
                        <label for="concepto-pago">Concepto:</label>
                        <select id="concepto-pago" required>
                            <option value="">Seleccione...</option>
                            <option value="Mensualidad">Mensualidad</option>
                            <option value="InscripciÃ³n">InscripciÃ³n</option>
                            <option value="Materiales">Materiales</option>
                            <option value="Uniforme">Uniforme</option>
                            <option value="Otro">Otro</option>
                        </select>
                    </div>
                    <button type="submit">Registrar Pago</button>
                </form>`;

                return html;
            }

            // Generar reportes
            generarReportes() {
                if (this.alumnos.length === 0) {
                    return '<div class="mensaje-vacio">No hay datos para mostrar</div>';
                }

                const totalAlumnos = this.alumnos.length;
                const totalRecaudado = this.alumnos.reduce((sum, alumno) => 
                    sum + alumno.pagos.reduce((sumPagos, pago) => sumPagos + pago.monto, 0), 0);
                const totalAdeudado = this.alumnos.reduce((sum, alumno) => sum + alumno.adeudo, 0);
                const alumnosConAdeudo = this.alumnos.filter(a => a.adeudo > 0).length;

                let html = `<div class="resumen">
                    <h3>Resumen General</h3>
                    <div class="metricas">
                        <div class="metrica">
                            <span class="valor">${totalAlumnos}</span>
                            <span class="etiqueta">Alumnos</span>
                        </div>
                        <div class="metrica">
                            <span class="valor">$${totalRecaudado.toFixed(2)}</span>
                            <span class="etiqueta">Recaudado</span>
                        </div>
                        <div class="metrica">
                            <span class="valor">$${totalAdeudado.toFixed(2)}</span>
                            <span class="etiqueta">Por cobrar</span>
                        </div>
                        <div class="metrica">
                            <span class="valor">${alumnosConAdeudo}</span>
                            <span class="etiqueta">Con adeudo</span>
                        </div>
                    </div>
                </div>`;

                // GrÃ¡fico de alumnos por grado (simplificado)
                const grados = {};
                this.alumnos.forEach(alumno => {
                    grados[alumno.grado] = (grados[alumno.grado] || 0) + 1;
                });

                html += `<div class="grafico-container">
                    <h3>Alumnos por Grado</h3>
                    <div class="grafico-barras">`;
                
                Object.entries(grados).forEach(([grado, cantidad]) => {
                    const porcentaje = (cantidad / totalAlumnos) * 100;
                    html += `<div class="barra">
                        <div class="etiqueta-grado">${grado}</div>
                        <div class="barra-progreso" style="width: ${porcentaje}%">
                            <span class="valor-barra">${cantidad}</span>
                        </div>
                    </div>`;
                });

                html += `</div></div>`;

                return html;
            }

            // MÃ©todos para sincronizaciÃ³n con JSONBin.io (opcional)
            async cargarDesdeJSONBin() {
                try {
                    const response = await fetch('https://api.jsonbin.io/v3/b/663a9d8ce41b4d34e4e60a6c/latest', {
                        headers: {
                            'X-Master-Key': '$2a$10$J9tZ8L5uW5eD5V5Q5z5XeO5V5Q5z5XeO5V5Q5z5XeO5V5Q5z5XeO'
                        }
                    });
                    
                    if (!response.ok) throw new Error('Error al cargar datos');
                    
                    const data = await response.json();
                    if (data.record && data.record.length > 0) {
                        this.alumnos = data.record;
                        localStorage.setItem('alumnosEscuela', JSON.stringify(this.alumnos));
                    }
                } catch (error) {
                    console.log("No se pudo cargar de JSONBin.io, usando datos locales");
                }
            }

            async guardarEnJSONBin() {
                try {
                    const response = await fetch('https://api.jsonbin.io/v3/b/663a9d8ce41b4d34e4e60a6c', {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': '$2a$10$J9tZ8L5uW5eD5V5Q5z5XeO5V5Q5z5XeO5V5Q5z5XeO5V5Q5z5XeO'
                        },
                        body: JSON.stringify(this.alumnos)
                    });
                    
                    if (!response.ok) throw new Error('Error al guardar datos');
                } catch (error) {
                    console.log("No se pudo guardar en JSONBin.io, solo se guardÃ³ localmente");
                }
            }
        }

        // Instancia global del sistema
        const sistemaEscolar = new SistemaEscolar();

        // Funciones para manejar la interfaz
        function mostrarSeccion(idSeccion) {
            // Ocultar todas las secciones
            document.querySelectorAll('.seccion').forEach(sec => {
                sec.classList.remove('seccion-activa');
            });
            
            // Mostrar la secciÃ³n seleccionada
            document.getElementById(idSeccion).classList.add('seccion-activa');
            
            // Actualizar el contenido si es necesario
            if (idSeccion === 'lista') {
                document.getElementById('contenedor-alumnos').innerHTML = sistemaEscolar.generarListaAlumnos();
            } else if (idSeccion === 'reportes') {
                document.getElementById('contenedor-reportes').innerHTML = sistemaEscolar.generarReportes();
            }
        }

        function mostrarPago(idAlumno) {
            mostrarSeccion('pagos');
            document.getElementById('contenedor-pagos').innerHTML = sistemaEscolar.generarFormularioPago(idAlumno);
            
            // Configurar el formulario de pago
            document.getElementById('formulario-pago')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const monto = document.getElementById('monto-pago').value;
                const concepto = document.getElementById('concepto-pago').value;
                
                if (sistemaEscolar.registrarPago(idAlumno, monto, concepto)) {
                    mostrarMensaje('Pago registrado exitosamente!');
                    mostrarSeccion('lista');
                } else {
                    mostrarMensaje('Error al registrar el pago', 'error');
                }
            });
        }

        function mostrarMensaje(texto, tipo = 'exito') {
            const mensaje = document.getElementById('mensaje-exito');
            mensaje.textContent = texto;
            mensaje.style.display = 'block';
            mensaje.style.backgroundColor = tipo === 'exito' ? '#d4edda' : '#f8d7da';
            mensaje.style.color = tipo === 'exito' ? '#155724' : '#721c24';
            
            setTimeout(() => {
                mensaje.style.display = 'none';
            }, 3000);
        }

        // InicializaciÃ³n al cargar la pÃ¡gina
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar el formulario de registro
            document.getElementById('formulario-alumno').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const nombre = document.getElementById('nombre').value.trim();
                const grado = document.getElementById('grado').value;
                const grupo = document.getElementById('grupo').value.trim().toUpperCase();
                const mensualidad = document.getElementById('mensualidad').value;
                const beca = document.getElementById('beca').value || 0;
                
                if (!nombre || !grado || !grupo || !mensualidad) {
                    mostrarMensaje('Por favor complete todos los campos', 'error');
                    return;
                }
                
                sistemaEscolar.registrarAlumno(nombre, grado, grupo, mensualidad, beca);
                
                mostrarMensaje('Alumno registrado exitosamente!');
                this.reset();
                
                // Actualizar la lista si estÃ¡ visible
                if (document.getElementById('lista').classList.contains('seccion-activa')) {
                    document.getElementById('contenedor-alumnos').innerHTML = sistemaEscolar.generarListaAlumnos();
                }
            });
            
            // Mostrar la secciÃ³n de registro por defecto
            mostrarSeccion('registro');
        });
    </script>
</body>
</html>
